name: Sync upstream bolt.diy
on:
  schedule: 
    - cron: "0 6 * * *"  # Diário às 06:00 UTC
  workflow_dispatch:     # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure git
        run: |
          git config --global user.name "UpTax Bot"
          git config --global user.email "bot@uptax.net"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/stackblitz-labs/bolt.diy.git || true
          git fetch upstream
      
      - name: Check for updates
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT
          echo "📊 Fork está $BEHIND commits atrás do upstream"
      
      - name: Merge upstream if needed
        if: steps.check.outputs.commits_behind > 0
        run: |
          git checkout main
          git merge --ff-only upstream/main || {
            echo "❌ Fast-forward merge falhou - conflitos podem existir"
            exit 1
          }
      
      - name: Push updates
        if: steps.check.outputs.commits_behind > 0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin main
          echo "✅ Fork atualizado com sucesso!"
      
      - name: Create notification issue
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "🚨 Sync upstream falhou - $(date)" \
            --body "Falha ao sincronizar com upstream bolt.diy. Verificar conflitos manualmente." \
            --label "sync-failure,priority-high"